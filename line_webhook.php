<?php
// ===============================
// DOOHOON AI â€“ LINE Webhook
// ===============================

// à¹‚à¸«à¸¥à¸” handler à¸—à¸µà¹ˆà¸£à¸§à¸¡ AI à¹à¸¥à¸° Finnhub
require_once __DIR__ . '/line_ai_handler.php';

// à¸­à¹ˆà¸²à¸™à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸µà¹ˆ LINE à¸ªà¹ˆà¸‡à¸¡à¸²
$body = file_get_contents('php://input');
$data = json_decode($body, true);

// âœ… à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸§à¹ˆà¸²à¸¡à¸µ events à¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ
if (!empty($data['events'])) {
    foreach ($data['events'] as $event) {

        $type = $event['type'] ?? '';
        if ($type === 'message' && ($event['message']['type'] ?? '') === 'text') {

            $text       = trim($event['message']['text'] ?? '');
            $replyToken = $event['replyToken'] ?? '';
            $userId     = $event['source']['userId'] ?? null;

            // âœ… à¸žà¸¢à¸²à¸¢à¸²à¸¡à¸ˆà¸±à¸”à¸à¸²à¸£à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸—à¸µà¹ˆà¹€à¸›à¹‡à¸™à¸Šà¸·à¹ˆà¸­à¸«à¸¸à¹‰à¸™ (9 à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡)
            $handled = attemptHandleStockQuery($text, $replyToken, $userId);
            if ($handled) {
                continue; // à¸–à¹‰à¸²à¸ˆà¸±à¸”à¸à¸²à¸£à¹à¸¥à¹‰à¸§ à¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡à¸—à¸³à¸•à¹ˆà¸­
            }

            // âœ… à¸–à¹‰à¸²à¹„à¸¡à¹ˆà¹ƒà¸Šà¹ˆà¸Šà¸·à¹ˆà¸­à¸«à¸¸à¹‰à¸™ à¹ƒà¸«à¹‰à¸•à¸­à¸šà¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸—à¸±à¹ˆà¸§à¹„à¸›
            if (in_array(mb_strtolower($text), ['à¸ªà¸§à¸±à¸ªà¸”à¸µ', 'hello', 'hi'])) {
                sendLineReply($replyToken, [
                    ["type" => "text", "text" => "à¸ªà¸§à¸±à¸ªà¸”à¸µà¸„à¸£à¸±à¸š ðŸ˜Š à¸œà¸¡à¸„à¸·à¸­ DOOHOON AI à¸œà¸¹à¹‰à¸Šà¹ˆà¸§à¸¢à¸”à¸¹à¸«à¸¸à¹‰à¸™à¸‚à¸­à¸‡à¸„à¸¸à¸“"]
                ]);
            } elseif (in_array(mb_strtolower($text), ['à¸«à¸¸à¹‰à¸™à¹à¸™à¸°à¸™à¸³', 'à¹à¸™à¸§à¹‚à¸™à¹‰à¸¡à¸•à¸¥à¸²à¸”à¸§à¸±à¸™à¸™à¸µà¹‰'])) {
                sendLineReply($replyToken, [
                    ["type" => "text", "text" => "ðŸ“Š à¹à¸™à¸§à¹‚à¸™à¹‰à¸¡à¸•à¸¥à¸²à¸”à¸§à¸±à¸™à¸™à¸µà¹‰à¸­à¸¢à¸¹à¹ˆà¹ƒà¸™à¸Šà¹ˆà¸§à¸‡à¸›à¸£à¸±à¸šà¸à¸²à¸™à¸£à¸°à¸¢à¸°à¸ªà¸±à¹‰à¸™à¸„à¸£à¸±à¸š"],
                    ["type" => "text", "text" => "à¸„à¸¸à¸“à¸ªà¸²à¸¡à¸²à¸£à¸–à¸žà¸´à¸¡à¸žà¹Œà¸Šà¸·à¹ˆà¸­à¸«à¸¸à¹‰à¸™à¹€à¸Šà¹ˆà¸™ NVDA, AAPL, MSFT à¹€à¸žà¸·à¹ˆà¸­à¸”à¸¹à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹à¸šà¸šà¸¥à¸°à¹€à¸­à¸µà¸¢à¸”à¹„à¸”à¹‰à¹€à¸¥à¸¢à¸„à¸£à¸±à¸š"]
                ]);
            } else {
                sendLineReply($replyToken, [
                    ["type" => "text", "text" => "à¸žà¸´à¸¡à¸žà¹Œà¸Šà¸·à¹ˆà¸­à¸«à¸¸à¹‰à¸™ (à¹€à¸Šà¹ˆà¸™ NVDA à¸«à¸£à¸·à¸­ AAPL) à¹€à¸žà¸·à¹ˆà¸­à¸”à¸¹à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸Šà¸´à¸‡à¸¥à¸¶à¸à¹„à¸”à¹‰à¹€à¸¥à¸¢à¸„à¸£à¸±à¸š ðŸ”"]
                ]);
            }
        }
    }
}

// âœ… à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸ªà¸–à¸²à¸™à¸° webhook (LINE à¸ˆà¸°à¸¢à¸´à¸‡à¸¡à¸²à¸—à¸”à¸ªà¸­à¸š)
http_response_code(200);
echo json_encode(["status" => "ok"]);
exit;
?>
