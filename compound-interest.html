<script>
  let growthChart = null;

  // ====== 1) พรีเซ็ตพื้นฐาน (ใช้เมื่อไม่เรียก API) ======
  const PRESET_MAP = {
    AAPL: { returnRate: 12, dividend: 0.5 },
    NVDA: { returnRate: 25, dividend: 0.03 },
    TSLA: { returnRate: 20, dividend: 0 },
    GOOGL:{ returnRate: 15, dividend: 0 },
    MSFT: { returnRate: 12, dividend: 0.8 },
    KO:   { returnRate: 8,  dividend: 3.0 },
  };

  // ====== 2) ตั้งค่าการใช้ API (ถ้าไม่มีคีย์ ใช้ false ไว้ก่อน) ======
  const USE_API = false; // ตั้ง true ถ้าคุณมีคีย์
  const API = {
    // ตัวอย่าง Alpha Vantage (ฟรี แต่มี rate limit)
    ALPHA_VANTAGE_KEY: 'YOUR_ALPHA_VANTAGE_KEY',
    // ตัวอย่าง Finnhub (เร็วและครบกว่า)
    FINNHUB_KEY: 'YOUR_FINNHUB_KEY'
  };

  // ====== 3) debounce กันยิง API ถี่เกินไป ======
  function debounce(fn, delay = 500) {
    let t = null;
    return (...args) => {
      clearTimeout(t);
      t = setTimeout(() => fn(...args), delay);
    };
  }

  // ====== 4) ดึงข้อมูลจาก API (ตัวอย่าง 2 เจ้าดัง) ======
  async function fetchStockData(symbol) {
    const sym = symbol.toUpperCase();

    // ตัวอย่าง Finnhub: ปันผลย้อนหลัง (สำหรับคำนวณ yield คร่าว ๆ)
    // และ quote ปัจจุบัน (ไม่ได้ใช้ตรง ๆ ในหน้านี้ แต่เผื่อขยายต่อ)
    // หมายเหตุ: เบราว์เซอร์อาจติด CORS ต้องใช้ผ่าน proxy/Server ของคุณ
    async function tryFinnhub() {
      const base = 'https://finnhub.io/api/v1';
      const divUrl = `${base}/stock/dividend?symbol=${sym}&from=2019-01-01&to=2030-01-01&token=${API.FINNHUB_KEY}`;
      const quoteUrl = `${base}/quote?symbol=${sym}&token=${API.FINNHUB_KEY}`;

      const [divRes, quoteRes] = await Promise.all([
        fetch(divUrl), fetch(quoteUrl)
      ]);
      if (!divRes.ok || !quoteRes.ok) throw new Error('Finnhub error');

      const divs = await divRes.json();
      const quote = await quoteRes.json();

      // คำนวณ dividend yield แบบคร่าว ๆ: รวมปันผล 1 ปีล่าสุด / ราคาปัจจุบัน
      let last12m = 0;
      const now = new Date();
      const cutoff = new Date(now.getFullYear() - 1, now.getMonth(), now.getDate());
      if (Array.isArray(divs)) {
        for (const d of divs) {
          if (d.payDate && new Date(d.payDate) >= cutoff) {
            last12m += (d.amount || 0);
          }
        }
      }
      const price = quote.c || 0;
      const dividendYield = price > 0 ? (last12m / price) * 100 : 0;

      // “ผลตอบแทนเฉลี่ยต่อปี” ไม่มีจาก API ตรง ๆ — ให้ตั้งสมมติฐานหรือดึงจาก backtest ของคุณเอง
      // ที่นี่ขอใส่ค่ากลาง 10% เป็นตัวอย่าง
      return {
        returnRate: 10,
        dividend: Number.isFinite(dividendYield) ? +(dividendYield.toFixed(2)) : 0
      };
    }

    // ตัวอย่าง Alpha Vantage: ไม่มี yield ตรง ๆ เช่นกัน
    async function tryAlphaVantage() {
      const base = 'https://www.alphavantage.co/query';
      const url = `${base}?function=OVERVIEW&symbol=${sym}&apikey=${API.ALPHA_VANTAGE_KEY}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error('AlphaVantage error');
      const data = await res.json();

      // Alpha Vantage มีฟิลด์ DividendYield เป็นอัตราส่วน (เช่น 0.008 -> 0.8%)
      const rawYield = parseFloat(data.DividendYield || '0');
      const dividendPct = isNaN(rawYield) ? 0 : rawYield * 100;

      return {
        returnRate: 10, // สมมติ
        dividend: +(dividendPct.toFixed(2))
      };
    }

    // ลอง Finnhub ก่อน ถ้าพังค่อยลอง Alpha Vantage
    if (API.FINNHUB_KEY && API.FINNHUB_KEY !== 'YOUR_FINNHUB_KEY') {
      try { return await tryFinnhub(); } catch {}
    }
    if (API.ALPHA_VANTAGE_KEY && API.ALPHA_VANTAGE_KEY !== 'YOUR_ALPHA_VANTAGE_KEY') {
      try { return await tryAlphaVantage(); } catch {}
    }

    // ถ้าไม่มีคีย์ หรือเรียกไม่ได้ ให้ fallback พรีเซ็ต
    if (PRESET_MAP[sym]) return PRESET_MAP[sym];

    // fallback สุดท้าย: สมมติฐานกลาง ๆ
    return { returnRate: 10, dividend: 1.0 };
  }

  // ====== 5) อัปเดตค่าผลตอบแทน/ปันผลเมื่อผู้ใช้ "พิมพ์" สัญลักษณ์ ======
  const onSymbolInput = debounce(async () => {
    const input = document.getElementById('stockSymbol');
    const sym = (input.value || '').trim().toUpperCase();
    if (!sym) return;

    // ล้างไฮไลต์ปุ่มพรีเซ็ต
    document.querySelectorAll('.stock-preset').forEach(el => el.classList.remove('active'));

    // ถ้ามีพรีเซ็ต ก็เติมให้ทันที (เร็ว)
    if (PRESET_MAP[sym]) {
      document.getElementById('annualReturn').value = PRESET_MAP[sym].returnRate;
      document.getElementById('dividendYield').value = PRESET_MAP[sym].dividend;
      return;
    }

    // ถ้าเปิดโหมด API — ลองดึงจริง
    if (USE_API) {
      try {
        const data = await fetchStockData(sym);
        document.getElementById('annualReturn').value = data.returnRate;
        document.getElementById('dividendYield').value = data.dividend;
      } catch (e) {
        // ถ้าดึงไม่ได้ ให้คงค่าที่ผู้ใช้ใส่ไว้/สมมติ
        console.warn('Fetch API failed, keep manual inputs.', e);
      }
    }
  }, 500);

  // bind กับ input ช่องสัญลักษณ์
  window.addEventListener('load', () => {
    document.getElementById('stockSymbol').addEventListener('input', onSymbolInput);
  });

  // ====== 6) ปุ่มพรีเซ็ต (แก้ให้รับ event) ======
  function selectStock(symbol, name, returnRate, dividend, ev) {
    document.getElementById('stockSymbol').value = symbol;
    document.getElementById('annualReturn').value = returnRate;
    document.getElementById('dividendYield').value = dividend;

    document.querySelectorAll('.stock-preset').forEach(el => el.classList.remove('active'));
    if (ev && ev.currentTarget) ev.currentTarget.classList.add('active');
  }

  // ====== 7) ฟังก์ชันคำนวณ (คงของเดิม) ======
  function calculate() {
    const stockSymbol = document.getElementById('stockSymbol').value.trim() || 'Stock';
    const initialInvestment = parseFloat(document.getElementById('initialInvestment').value) || 0;
    const annualReturn = parseFloat(document.getElementById('annualReturn').value) || 0;
    const dividendYield = parseFloat(document.getElementById('dividendYield').value) || 0;
    const years = parseFloat(document.getElementById('years').value) || 0;
    const monthlyInvestment = parseFloat(document.getElementById('monthlyInvestment').value) || 0;

    if (initialInvestment <= 0 || years <= 0) {
      alert('⚠️ กรุณากรอกเงินลงทุนและระยะเวลา');
      return;
    }

    const monthlyReturn = annualReturn / 100 / 12;
    const monthlyDividend = dividendYield / 100 / 12;
    const totalMonths = years * 12;

    let portfolioValue = initialInvestment;
    let totalInvested = initialInvestment;
    let totalDividends = 0;

    const yearlyData = [{ year: 0, invested: initialInvestment, value: initialInvestment }];

    for (let month = 1; month <= totalMonths; month++) {
      portfolioValue += monthlyInvestment;
      totalInvested += monthlyInvestment;

      portfolioValue *= (1 + monthlyReturn);

      const dividendAmount = portfolioValue * monthlyDividend;
      portfolioValue += dividendAmount;
      totalDividends += dividendAmount;

      if (month % 12 === 0) {
        yearlyData.push({
          year: month / 12,
          invested: totalInvested,
          value: portfolioValue
        });
      }
    }

    const capitalGain = portfolioValue - totalInvested - totalDividends;
    const multiplier = (portfolioValue / totalInvested).toFixed(2);

    document.getElementById('resultStockSymbol').textContent = stockSymbol;
    document.getElementById('finalAmount').textContent = portfolioValue.toLocaleString(undefined, {
      minimumFractionDigits: 0,
      maximumFractionDigits: 0
    });
    document.getElementById('multiplier').innerHTML = `เงินเพิ่มขึ้น <strong>${multiplier}x</strong>`;

    document.getElementById('totalInvested').textContent = '฿' + totalInvested.toLocaleString(undefined, {
      minimumFractionDigits: 0,
      maximumFractionDigits: 0
    });
    document.getElementById('capitalGain').textContent = '฿' + capitalGain.toLocaleString(undefined, {
      minimumFractionDigits: 0,
      maximumFractionDigits: 0
    });
    document.getElementById('totalDividends').textContent = '฿' + totalDividends.toLocaleString(undefined, {
      minimumFractionDigits: 0,
      maximumFractionDigits: 0
    });

    document.getElementById('detailStock').textContent = stockSymbol;
    document.getElementById('detailInitial').textContent = '฿' + initialInvestment.toLocaleString();
    document.getElementById('detailMonthly').textContent = '฿' + monthlyInvestment.toLocaleString();
    document.getElementById('detailReturn').textContent = annualReturn + '%';
    document.getElementById('detailDividend').textContent = dividendYield + '%';
    document.getElementById('detailYears').textContent = years + ' ปี';
    document.getElementById('detailFinal').textContent = '฿' + portfolioValue.toLocaleString(undefined, {
      minimumFractionDigits: 0,
      maximumFractionDigits: 0
    });

    drawChart(yearlyData);

    const resultDiv = document.getElementById('result');
    resultDiv.style.display = 'block';
    resultDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }

  function drawChart(yearlyData) {
    const labels = yearlyData.map(d => 'ปีที่ ' + d.year);
    const investedData = yearlyData.map(d => d.invested);
    const valueData = yearlyData.map(d => d.value);

    if (growthChart) growthChart.destroy();

    const ctx = document.getElementById('growthChart').getContext('2d');
    growthChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [
          {
            label: 'เงินลงทุนสะสม',
            data: investedData,
            borderColor: '#daa520',
            backgroundColor: 'rgba(218, 165, 32, 0.1)',
            borderWidth: 2,
            fill: true,
            tension: 0.4
          },
          {
            label: 'มูลค่าพอร์ตรวมปันผล',
            data: valueData,
            borderColor: '#ffd700',
            backgroundColor: 'rgba(255, 215, 0, 0.2)',
            borderWidth: 3,
            fill: true,
            tension: 0.4
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: {
            labels: {
              color: '#fff',
              font: { size: 12, family: 'Poppins' }
            }
          },
          tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.8)',
            titleColor: '#ffd700',
            bodyColor: '#fff',
            borderColor: '#ffd700',
            borderWidth: 1,
            callbacks: {
              label: function(context) {
                return context.dataset.label + ': ฿' + context.parsed.y.toLocaleString(undefined, {
                  minimumFractionDigits: 0,
                  maximumFractionDigits: 0
                });
              }
            }
          }
        },
        scales: {
          x: {
            grid: { color: 'rgba(255, 215, 0, 0.1)' },
            ticks: { color: '#888', font: { family: 'Poppins' } }
          },
          y: {
            grid: { color: 'rgba(255, 215, 0, 0.1)' },
            ticks: {
              color: '#888',
              font: { family: 'Poppins' },
              callback: v => '฿' + v.toLocaleString()
            }
          }
        }
      }
    });
  }

  document.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') calculate();
  });

  window.addEventListener('load', calculate);
</script>
